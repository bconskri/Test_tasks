## Требования к выполнению

Задания должны быть выполнены на языке запросов SQL и выполняться без ошибок на реальной базе данных PostgreSQL 12 и выше.

Для выполнения заданий необходимо установить локальный сервер базы данных PostgreSQL версии 12 или выше. Приложенные к тестовому заданию исходные данные необходимо загрузить на этот сервер.

Решения заданий можно приложить в виде отдельных файлов SQL или вставить в README.md в блоки кода.

### Задание 1

Подготовить витрину с данными по контрактам.

Данные для витрины хранятся в файлах CSV в директории `data`, которые необходимо загрузить в базу данных.

Описание файлов исходных данных для формирования витрины:

- test_data_contract.csv - общая информация о контрактах.
  * customer_id - ID клиента.
  * contract_id - ID контракта.
  * contract_code - код контракта в CRM.
  * marker_delete - пометка на удаление.
  * issue_dt - дата заключения контракта.
  * subdivision_id - ID подразделения, заключившего контракт.
  * renewal_contract_id - ID контракта, который стал причиной переоформления.
- test_data_contract_conditions.csv - информация об изменении условий контракта, в том числе перенос срока и продление.
  * condition_id - ID изменения условий контракта.
  * condition_dt - дата изменения условия.
  * contract_id - ID контракта.
  * conducted - признак проведения изменения в CRM.
  * marker_delete - пометка на удаление.
  * operation_type - тип операции.
  * condition_type - тип изменения условий.
  * condition_start_dt - дата начала действия изменения условий. Относится к сроку действия контракта или продления.
  * condition_end_dt - дата окончания действия изменения условий. Относится к сроку действия контракта или продления.
  * days - срок действия изменения условий в днях.
- test_data_contract_conditions_payment_plan.csv - план-график выплат по контракту. Генерируется для каждого изменения условий.
  * condition_id - ID изменения условия контракта.
  * payment_dt - дата платежа.
  * loan_amount - сумма платежа.
- test_data_contract_status.csv - информация об изменении статуса контракта.
  * contract_id - ID контракта.
  * status_dt - дата и время статуса контракта.
  * status_type - вид статуса контракта.

Необходимо получить итоговую таблицу (витрину) со следущим набором столбцов:

- contract_id - ID контракта.
- contract_code - Код контракта.
- customer_id - ID клиента.
- condition_id - ID документа о заключении контракта.
- subdivision_id - ID подразделения, заключившего контракт.
- contract_serial_number - Порядковый номер контракта у клиента.
- contract_renewal_serial_number - Порядковый номер контракта у клиента без учёта переоформлений. Если контракт является переоформлением, порядковый номер не должен увеличиваться.
- is_renewal - Является ли данный контракт переоформлением (наличие ID в поле renewal_contract_id).
- is_installment - Является ли данный контракт долгосрочным (наличие нескольких платежей в плане погашений).
- prolong_count - Количество продлений. Контракт может быть продлён неограниченное количество раз (см. test_data_contract_conditions.condition_type).
- first_issue_dt - Дата первого контракта у клиента.
- issue_dt - Дата выдачи займа.
- plan_dt - Дата планового погашения займа.
- last_plan_dt - Дата планового погашения займа с учётом продлений.
- close_dt - Дата фактического погашения займа (дата закрытия). Учитывается только последний статус по контракту.
- loan_amount - Сумма займа. Суммируются все платежи по графику.
- total_loan_amount - Сумма всех предыдущих займов.
- min_loan_amount - Минимальная сумма предыдущих займов.
- max_loan_amount - Максимальная сумма предыдущих займов.
- loan_term - Срок займа в днях.
- min_loan_term - Минимальный срок предыдущих займов.
- max_loan_term - Максимальный срок предыдущих займов.
- is_closed - Является ли контракт закрытым на текущий момент. Закрытым считаем контракт со следующими статусами: «Закрыт», «Договор закрыт с переплатой», «Переоформлен».
- usage_days - Количество дней фактического использования займа (для закрытых). Разница между датой закрытия и открытия займа.
- dev_days - Разница между датой закрытия и последней датой планового погашения (для закрытых).
- delay_days - Количество дней с даты закрытия предыдущего займа у клиента и датой открытия текущего.
- has_next - Признак наличия следующего контракта у клиента.

Условия для сборки итоговой таблицы (витрины):

- первичный ключ итоговой таблицы: contract_id.
- индексы в итоговой таблице: contract_id, customer_id, condition_id.
- к таблице и столбцам необходимо добавить комментарии в базе данных с описанием содержимого.
- типы данных итоговой таблицы необходимо определить на основе исходных данных.
- в витрину не должны попасть данные помеченные на удаление (поле `mark_delete`) и непроведённые документы (поле `conducted`). 
- для извлечения условий договора используются только операции «ЗаключениеДоговора» (см. test_data_contract_conditions.operation_type).

Решением данного залания должен быть код создания таблицы на основе SQL-запроса вида:

```sql
CREATE TABLE v_contract (....);
INSERT INTO v_contract SELECT ....;
CREATE INDEX ....;
COMMENT ON TABLE  ....;
COMMENT ON COLUMN ....;
```

### Задание 2

На основе таблицы, сформированной в задании 1, сформировать выборку по следующим условиям:

1. Выбрать клиентов, пришедших в 2019 году (т.е. первый договор датирован 2019 годом).
2. Сгруппировать клиентов в группы по году и месяцу первого контракта.
2. В каждой группе определить клиента (-ов) с максимальным порядковым номером контракта клиента.
3. Определить во сколько раз увеличилась сумма последнего контракта относительно первого по найденным клиентам в каждой группе.

Решением данной задачи должен быть код запроса вида:

```sql
SELECT ....;
```
